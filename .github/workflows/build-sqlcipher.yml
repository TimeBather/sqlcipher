name: Build SQLCipher Windows

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout SQLCipher
        uses: actions/checkout@v4

      # 1. 安装 OpenSSL (SQLCipher 的加密提供程序)
      - name: Install OpenSSL via vcpkg
        run: |
          vcpkg install openssl:x64-windows
          vcpkg integrate install

      # 2. 设置 MSVC 编译环境 (Developer Command Prompt)
      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 3. 准备生成源码 (SQLCipher 需要先处理 Makefile.msc)
      # 提示：Windows 下通常直接修改 Makefile.msc 或在命令行通过 OPTS 传递宏
      - name: Build SQLCipher
        shell: cmd
        run: |
          :: 定义宏参数
          SET SQLITE_FLAGS=-DSQLITE_HAS_CODEC ^
                           -DSQLITE_TEMP_STORE=2 ^
                           -DSQLITE_EXTRA_INIT=sqlcipher_extra_init ^
                           -DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown ^
                           -DSQLITE_THREADSAFE=1

          :: 获取 OpenSSL 的路径 (基于 vcpkg)
          SET OPENSSL_DIR=${{ github.workspace }}\vcpkg_installed\x64-windows

          :: 执行编译命令
          :: 我们将宏注入到 CFLAGS，并链接 OpenSSL 的库
          nmake /f Makefile.msc ^
            "OPTS=%SQLITE_FLAGS%" ^
            "RCCOPTS=-DSQLITE_HAS_CODEC" ^
            "LDFLAGS=libcrypto.lib libssl.lib /LIBPATH:\"%OPENSSL_DIR%\lib\"" ^
            "INCLUDE=.;\"%OPENSSL_DIR%\include\"" ^
            sqlcipher.exe libsqlcipher.lib

      # 4. 验证生成的工件
      - name: Check Artifacts
        shell: bash
        run: |
          ls -l sqlcipher.exe
          ls -l libsqlcipher.lib

      # 5. 上传编译结果
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sqlcipher-windows-x64
          path: |
            sqlcipher.exe
            libsqlcipher.lib
            sqlite3.h